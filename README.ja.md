# ğŸ“˜ Maestro Orchestrator â€” Orchestration Framework (fail-closed + HITL)

[![GitHub stars](https://img.shields.io/github/stars/japan1988/multi-agent-mediation?style=social)](https://github.com/japan1988/multi-agent-mediation/stargazers)
![License](https://img.shields.io/github/license/japan1988/multi-agent-mediation)
[![CI](https://github.com/japan1988/multi-agent-mediation/actions/workflows/python-app.yml/badge.svg?branch=main)](https://github.com/japan1988/multi-agent-mediation/actions/workflows/python-app.yml)
[![tasukeru-analysis](https://github.com/japan1988/multi-agent-mediation/actions/workflows/tasukeru-analysis.yml/badge.svg?branch=main)](https://github.com/japan1988/multi-agent-mediation/actions/workflows/tasukeru-analysis.yml)

> **If uncertain, stop. If risky, escalate.**  
> ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆçš„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å‘ã‘ã®ã‚¬ãƒãƒŠãƒ³ã‚¹ãƒ»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç ”ç©¶ï¼æ•™è‚²ç›®çš„ï¼‰

---

## âš ï¸ ç›®çš„ãƒ»å…è²¬ï¼ˆç ”ç©¶ï¼æ•™è‚²ï¼‰

**æœ¬ãƒªãƒã‚¸ãƒˆãƒªã¯ç ”ç©¶ï¼æ•™è‚²ç›®çš„ã®å‚ç…§å®Ÿè£…ï¼ˆãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ï¼‰ã§ã™ã€‚**  
æœ‰å®³è¡Œç‚ºï¼ˆä¾‹ï¼šä¾µå…¥ã€æ‚ªç”¨ã€ç›£è¦–ã€ãªã‚Šã™ã¾ã—ã€ç ´å£Šã€ãƒ‡ãƒ¼ã‚¿çªƒå–ï¼‰ã®å®Ÿè¡Œãƒ»åŠ©é•·ã€ã¾ãŸã¯é©ç”¨ã•ã‚Œã‚‹åˆ©ç”¨è¦ç´„ï¼ãƒãƒªã‚·ãƒ¼ï¼æ³•ä»¤ï¼å†…éƒ¨è¦ç¨‹ã«åã™ã‚‹åˆ©ç”¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã›ã‚“ã€‚  

æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ **æ•™è‚²ï¼ç ”ç©¶** ã¨ **é˜²å¾¡çš„æ¤œè¨¼**ï¼ˆä¾‹ï¼šãƒ­ã‚°è‚¥å¤§ã®æŠ‘åˆ¶ã€fail-closed + HITL ã®æŒ™å‹•æ¤œè¨¼ï¼‰ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚  
**æ”»æ’ƒæ‰‹å£ã®å…¬é–‹**ã‚„**ä¸æ­£è¡Œç‚ºã®æ”¯æ´**ã¯ç›®çš„ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

### ãƒªã‚¹ã‚¯ï¼ä¿è¨¼ï¼è²¬ä»»ç¯„å›²

- **è‡ªå·±è²¬ä»»ã§åˆ©ç”¨:** åˆ©ç”¨ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã®è¦ç´„ï¼ãƒãƒªã‚·ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
- **éš”é›¢ç’°å¢ƒã§é–‹å§‹:** ã¾ãšã¯ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆï¼ˆå¤–éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãªã—ï¼å®Ÿãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰ã€‚
- **ç¾çŠ¶æœ‰å§¿ï¼ˆAS ISï¼‰ï¼ç„¡ä¿è¨¼:** ã„ã‹ãªã‚‹ä¿è¨¼ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚
- **è²¬ä»»åˆ¶é™:** é©ç”¨æ³•ä»¤ã§è¨±ã•ã‚Œã‚‹æœ€å¤§é™ã®ç¯„å›²ã§ã€æœ¬ã‚³ãƒ¼ãƒ‰ï¼æ–‡æ›¸ï¼ç”Ÿæˆç‰©ï¼ˆç¬¬ä¸‰è€…ã«ã‚ˆã‚‹æ‚ªç”¨ã‚’å«ã‚€ï¼‰ã®åˆ©ç”¨ã«èµ·å› ã™ã‚‹æå®³ã«ã¤ã„ã¦ã€ä½œè€…ã¯è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚

### ã‚³ãƒ¼ãƒ‰ãƒ–ãƒƒã‚¯ã«é–¢ã™ã‚‹å…è²¬

åŒæ¢±ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒƒã‚¯ã¯ **ãƒ‡ãƒ¢ï¼å‚ç…§ç”¨**ã§ã™ã€‚å®Ÿé‹ç”¨ã«ãã®ã¾ã¾ä½¿ã‚ãšã€è¦ä»¶ãƒ»è„…å¨ãƒ¢ãƒ‡ãƒ«ãƒ»é©ç”¨ãƒãƒªã‚·ãƒ¼ï¼è¦ç´„ã«åŸºã¥ã„ã¦è‡ªä½œã—ã¦ãã ã•ã„ã€‚  
ã‚³ãƒ¼ãƒ‰ãƒ–ãƒƒã‚¯ã¯ãƒ­ã‚°é …ç›®ã®ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªç¬¦å·åŒ–ï¼å¾©å·ã®ãŸã‚ã®ã‚‚ã®ã§ã€**æš—å·ã§ã¯ã‚ã‚Šã¾ã›ã‚“**ï¼ˆç§˜åŒ¿æ€§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰ã€‚

### ãƒ†ã‚¹ãƒˆï¼çµæœã«é–¢ã™ã‚‹å…è²¬

ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆã‚„ã‚¹ãƒˆãƒ¬ã‚¹ãƒ©ãƒ³ã¯ã€ç‰¹å®šæ¡ä»¶ä¸‹ã§å®Ÿè¡Œã—ãŸç¯„å›²ã®æ¤œè¨¼ã«éãã¾ã›ã‚“ã€‚  
å®Ÿé‹ç”¨ã«ãŠã‘ã‚‹æ­£ç¢ºæ€§ï¼å®‰å…¨æ€§ï¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼é©åˆæ€§ã‚’ä¿è¨¼ã—ã¾ã›ã‚“ã€‚OSï¼Pythonï¼ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ï¼è¨­å®šï¼é‹ç”¨æ¡ä»¶ã«ã‚ˆã‚Šçµæœã¯å¤‰å‹•ã—ã¾ã™ã€‚

---

ğŸ‡ºğŸ‡¸ **English version:** [README.md](README.md)

## âš¡ TL;DR
- **Fail-closed + HITL** ã®ã‚²ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ»ãƒ™ãƒ³ãƒï¼ˆäº¤æ¸‰ï¼èª¿åœç³»ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å‘ã‘ã€ç ”ç©¶ï¼æ•™è‚²ï¼‰
- **å†ç¾æ€§å„ªå…ˆ**ï¼šseed å›ºå®šï¼‹ `pytest` å¥‘ç´„ãƒ†ã‚¹ãƒˆï¼ˆèªå½™ï¼ä¸å¤‰æ¡ä»¶ï¼‰
- **ç›£æŸ»å‰æ**ï¼šæœ€å° ARL ãƒ­ã‚°ï¼‹å¿…è¦æ™‚ã®ã¿ç•°å¸¸ï¼ˆincidentï¼‰ä¿å­˜ï¼ˆ`INC#...`ï¼‰ã§ãƒ­ã‚°è‚¥å¤§ã‚’å›é¿

---

## æ¦‚è¦

Maestro Orchestrator ã¯ã€ç ”ç©¶ï¼æ•™è‚²å‘ã‘ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚é‡è¦–ã™ã‚‹ã®ã¯ä»¥ä¸‹ã§ã™ï¼š

- **Fail-closed**  
  ä¸ç¢ºå®Ÿï¼ä¸å®‰å®šï¼ãƒªã‚¹ã‚¯ã‚ã‚Š â†’ é»™ã£ã¦ç¶šè¡Œã—ãªã„
- **HITLï¼ˆHuman-in-the-Loopï¼‰**  
  äººé–“ã®åˆ¤æ–­ãŒå¿…è¦ãªå ´é¢ã¯æ˜ç¤ºçš„ã«ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹
- **ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£**  
  åˆ¤æ–­ãƒ•ãƒ­ãƒ¼ã‚’æœ€å° ARL ãƒ­ã‚°ã§ç›£æŸ»ãƒ»å†ç¾å¯èƒ½ã«ã™ã‚‹

ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã¯ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ»ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆå‚ç…§å®Ÿè£…ï¼‰ã¨ã€äº¤æ¸‰ï¼èª¿åœï¼ã‚¬ãƒãƒŠãƒ³ã‚¹ç³»ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å‘ã‘ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒ™ãƒ³ãƒï¼ˆã‚²ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æŒ™å‹•ã®æ¤œè¨¼ï¼‰ãŒå«ã¾ã‚Œã¾ã™ã€‚

---

## æœ€æ–°ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆï¼ˆã“ã®ãƒªãƒã‚¸ãƒˆãƒªã§ä½•ãŒå¤‰ã‚ã£ãŸã‹ï¼‰

ä»Šå›ã®æ›´æ–°ã§ã€ç·Šæ€¥å¥‘ç´„ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã® **zip åŒæ¢±ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸**ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

- è¿½åŠ ï¼š`docs/mediation_emergency_contract_sim_pkg.zip`ï¼ˆv5.1.2 ã®åˆ©ä¾¿æ€§ãƒãƒ³ãƒ‰ãƒ«ï¼‰
- ç›®çš„ï¼šã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã‚’å¤‰ãˆãšã«ã€seed å›ºå®šã®ã‚¹ãƒ¢ãƒ¼ã‚¯ï¼ã‚¹ãƒˆãƒ¬ã‚¹ã‚’ **ã™ãå®Ÿè¡Œ**ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
- æ­£ï¼ˆæ¨©å¨ï¼‰ã¨ãªã‚‹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆsource of truthï¼‰ï¼š
  - `mediation_emergency_contract_sim_v5_1_2.py`
  - `pytest -q tests/test_v5_1_codebook_consistency.py`
- CI ã¸ã®å½±éŸ¿ï¼šãªã—ï¼ˆdocs ã®æˆæœç‰©ã€‚entrypoint ã§ã¯ãªã„ï¼‰
- æ³¨ï¼šzip ã¯ **ç”Ÿæˆï¼åˆ©ä¾¿æ€§ã®ãŸã‚ã®æˆæœç‰©**ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼å¯èƒ½ãªè¨¼è·¡ã§ã‚ã‚Šã€æ¨©å¨ãƒ­ã‚¸ãƒƒã‚¯ã§ã¯ãªã„ï¼‰ã€‚åˆ©ç”¨å‰ã«å†…å®¹ç¢ºèªã—ã¦ãã ã•ã„ã€‚

### ã“ã®æ›´æ–°ã§ç›´ã—ãŸç‚¹ï¼ˆæ—§ãƒ‰ãƒ©ãƒ•ãƒˆ â†’ ç¾è¡Œï¼‰

å‰ã® v5.1.2 ãƒ‰ãƒ©ãƒ•ãƒˆã§è¦‹ã¤ã‹ã£ãŸ **ã‚¹ã‚±ãƒ¼ãƒ«å•é¡Œ 2ç‚¹**ã‚’ä¿®æ­£ã—ã¦ã„ã¾ã™ï¼š

- **incident-only æ°¸ç¶šåŒ–ã¨çŸ›ç›¾ã™ã‚‹ FULL å¼·åˆ¶**
  - å•é¡Œï¼šè©•ä¾¡ï¼å ±é…¬ãªã©ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒ `force_full=True` ã§ FULL ã¨ã—ã¦æ°¸ç¶šåŒ–ã•ã‚Œã€æ­£å¸¸ç³»ã§ã‚‚ãƒ­ã‚°è‚¥å¤§ã‚’æ‹›ãå¾—ã‚‹ã€‚
  - æ”¹å–„ï¼šè©•ä¾¡ï¼å ±é…¬ã‚¤ãƒ™ãƒ³ãƒˆã¯ **SUMMARY ã§è¨˜éŒ²**ï¼ˆå¼·åˆ¶æ°¸ç¶šåŒ–ã—ãªã„ï¼‰ã€‚ARL æ°¸ç¶šåŒ–ã¯ **incident-only** ã‚’ç¶­æŒã€‚

- **`run_id` ãŒãƒ¦ãƒ‹ãƒ¼ã‚¯ãªå ´åˆã®å€™è£œãƒãƒƒãƒ•ã‚¡å¢—åŠ **
  - å•é¡Œï¼š`full_context_n > 0` ã‹ã¤å„ run ãŒãƒ¦ãƒ‹ãƒ¼ã‚¯ `run_id` ã ã¨ã€ãƒ¡ãƒ¢ãƒªä¸Šã®å€™è£œï¼ˆpre-contextï¼‰ãƒãƒƒãƒ•ã‚¡ãŒå¤§è¦æ¨¡ãƒ©ãƒ³ã§è“„ç©ã—å¾—ã‚‹ã€‚
  - æ”¹å–„ï¼šå„ run çµ‚äº†æ™‚ã« `drop_candidates_for_run(run_id)` ã‚’å‘¼ã³ã€run å˜ä½ã§å€™è£œã‚’ç¢ºå®Ÿã«ç ´æ£„ã€‚

---

## ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆæ¨å¥¨æ‰‹é †ï¼‰

v5.1.x ã¯å†ç¾æ€§ï¼‹å¥‘ç´„ãƒ†ã‚¹ãƒˆå‘ã‘ã«æ¨å¥¨ã€v4.x ã¯ãƒ¬ã‚¬ã‚·ãƒ¼ã®å®‰å®šãƒ™ãƒ³ãƒã¨ã—ã¦ä¿æŒã€‚  
ã¾ãš 1æœ¬å‹•ã‹ã—ã¦ãƒ­ã‚°ã¨æŒ™å‹•ã‚’ç¢ºèªã—ã€æ®µéšçš„ã«æ‹¡å¼µã—ã¾ã™ã€‚

### 1) æ¨å¥¨ï¼šç·Šæ€¥å¥‘ç´„ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆv5.1.2ï¼‰ã‚’å®Ÿè¡Œ

ä»»æ„ï¼š`docs/mediation_emergency_contract_sim_pkg.zip`ï¼ˆåˆ©ä¾¿æ€§ã®ã¿ï¼‰

```bash
python mediation_emergency_contract_sim_v5_1_2.py --runs 100
````

### 2) å¥‘ç´„ãƒ†ã‚¹ãƒˆï¼ˆv5.1.xï¼šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼‹ã‚³ãƒ¼ãƒ‰ãƒ–ãƒƒã‚¯æ•´åˆï¼‰

```bash
pytest -q tests/test_v5_1_codebook_consistency.py
```

### 3) ãƒ‡ãƒ¢ã‚³ãƒ¼ãƒ‰ãƒ–ãƒƒã‚¯ã®ç¢ºèªï¼å›ºå®šï¼ˆv5.1-demo.1ï¼‰

* `log_codebook_v5_1_demo_1.json`ï¼ˆãƒ‡ãƒ¢ã€‚æˆæœç‰©ã®äº¤æ›æ™‚ã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³å›ºå®šæ¨å¥¨ï¼‰
* æ³¨ï¼šã‚³ãƒ¼ãƒ‰ãƒ–ãƒƒã‚¯ã¯ **æš—å·ã§ã¯ã‚ã‚Šã¾ã›ã‚“**ï¼ˆç§˜åŒ¿æ€§ãªã—ï¼‰

### 4) ä»»æ„ï¼šãƒ¬ã‚¬ã‚·ãƒ¼å®‰å®šãƒ™ãƒ³ãƒï¼ˆv4.8ï¼‰

```bash
python mediation_emergency_contract_sim_v4_8.py
pytest -q tests/test_mediation_emergency_contract_sim_v4_8_smoke_metrics.py
```

### 5) ä»»æ„ï¼šè¨¼æ‹ ãƒãƒ³ãƒ‰ãƒ«ï¼ˆv4.8 ç”Ÿæˆæˆæœç‰©ï¼‰

* `docs/artifacts/v4_8_artifacts_bundle.zip`

è¨¼æ‹ ãƒãƒ³ãƒ‰ãƒ«ï¼ˆzipï¼‰ã¯ãƒ†ã‚¹ãƒˆï¼ãƒ©ãƒ³ãŒç”Ÿæˆã™ã‚‹æˆæœç‰©ã§ã™ã€‚
æ­£ï¼ˆæ¨©å¨ï¼‰ã¨ãªã‚‹ã®ã¯ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‹ãƒ†ã‚¹ãƒˆã§ã™ã€‚

---

## ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆï¼ˆsafe-by-defaultï¼‰

v5.1.2 ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ¡ãƒ¢ãƒªç ´è£‚ã‚’é¿ã‘ã‚‹è¨­è¨ˆã§ã™ï¼š

* é›†è¨ˆã®ã¿ï¼ˆ`keep_runs=False` ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ï¼šrun ã”ã¨ã®çµæœã‚’ãƒ¡ãƒ¢ãƒªã«ä¿æŒã—ãªã„
* ä»»æ„ï¼šç•°å¸¸æ™‚ã®ã¿ ARL ã‚’ä¿å­˜ï¼ˆ`INC#...` ã§ incident indexï¼‰

### A) ã‚¹ãƒ¢ãƒ¼ã‚¯ â†’ ä¸­è¦æ¨¡ã‚¹ãƒˆãƒ¬ã‚¹ï¼ˆæ¨å¥¨ãƒ©ãƒ³ãƒ—ï¼‰

```bash
# 1) Smoke
python mediation_emergency_contract_sim_v5_1_2.py --runs 200

# 2) Medium stressï¼ˆé›†è¨ˆã®ã¿ã®ã¾ã¾ï¼‰
python mediation_emergency_contract_sim_v5_1_2.py --runs 10000 --seed 42
```

### B) incident ã‚’æ„å›³çš„ã«ç™ºç”Ÿï¼ˆä¾‹ï¼šfabricate-rate 10% ã‚’ 200 runsï¼‰

ç•°å¸¸ run ãŒç™ºç”Ÿã—ã€è¨­å®šã«ã‚ˆã‚Š `INC#` ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ï¼š

```bash
python mediation_emergency_contract_sim_v5_1_2.py \
  --runs 200 \
  --fabricate-rate 0.1 \
  --seed 42 \
  --save-arl-on-abnormal \
  --arl-out-dir arl_out \
  --max-arl-files 1000
```

ç•°å¸¸æ™‚ã®å‡ºåŠ›ï¼š

* `arl_out/INC#000001__SIM#B000xx.arl.jsonl`ï¼ˆincident ARLï¼‰
* `arl_out/incident_index.jsonl`ï¼ˆincident 1ä»¶ã«ã¤ã1è¡Œï¼‰
* `arl_out/incident_counter.txt`ï¼ˆæ°¸ç¶šã‚«ã‚¦ãƒ³ã‚¿ï¼‰

Tipï¼š`--max-arl-files` ã§ãƒ‡ã‚£ã‚¹ã‚¯å¢—åŠ ã‚’ä¸Šé™ç®¡ç†ã€‚

---

## å›³ãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

å›³ã¨ãƒãƒ³ãƒ‰ãƒ«ã®ä¸€è¦§ï¼š **[docs/README.md](docs/README.md)**

ä¸»è¦å›³ï¼š

* Emergency contract overview (v5.1.2): [docs/architecture_v5_1_2_emergency_contract_overview.png](docs/architecture_v5_1_2_emergency_contract_overview.png)
* Architecture (code-aligned): [docs/architecture_code_aligned.png](docs/architecture_code_aligned.png)
* Unknown-progress + HITL: [docs/architecture_unknown_progress.png](docs/architecture_unknown_progress.png)
* Multi-agent hierarchy: [docs/multi_agent_hierarchy_architecture.png](docs/multi_agent_hierarchy_architecture.png)
* Sentiment context flow: [docs/sentiment_context_flow.png](docs/sentiment_context_flow.png)

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆæ¦‚è¦ï¼‰

ç›£æŸ»å‰æï¼†fail-closed ã®åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ï¼š

```text
agents
  â†’ mediatorï¼ˆrisk / pattern / factï¼‰
  â†’ evidence verification
  â†’ HITLï¼ˆpause / reset / banï¼‰
  â†’ audit logsï¼ˆARLï¼‰
```

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆoverview, v5.1.2ï¼‰

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã¿ã€‚ãƒ­ã‚¸ãƒƒã‚¯å¤‰æ›´ãªã—ã€‚

<p align="center">
  <img src="docs/architecture_v5_1_2_emergency_contract_overview.png"
       alt="Emergency contract simulator overview (v5.1.2)"
       width="860">
</p>

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆcode-aligned å›³ï¼‰

ç¾è¡Œã‚³ãƒ¼ãƒ‰ã®èªå½™ã«æƒãˆãŸå›³ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã¿ã€‚ãƒ­ã‚¸ãƒƒã‚¯å¤‰æ›´ãªã—ã€‚

<p align="center">
  <img src="docs/architecture_code_aligned.png" alt="Architecture (code-aligned)" width="720">
</p>

---

## v5.0.1 â†’ v5.1.2ï¼šä½•ãŒå¤‰ã‚ã£ãŸã‹ï¼ˆå·®åˆ†ï¼‰

v5.1.2 ã¯ã€å¤§è¦æ¨¡ run ã®å®‰å®šæ€§ã¨ incident-only æ°¸ç¶šåŒ–ã‚’å¼·åŒ–ã—ã¦ã„ã¾ã™ã€‚

* **Index + é›†è¨ˆã®ã¿ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåŒ–**

  * run ã”ã¨ã®çµæœã‚’ãƒ¡ãƒ¢ãƒªã«ä¿æŒã—ãªã„ï¼ˆ`--runs` å¤§ã§ã‚‚ç ´è£‚ã—ã«ãã„ï¼‰
  * å‡ºåŠ›ã¯ã‚«ã‚¦ãƒ³ã‚¿ï¼‹HITL ã‚µãƒãƒªï¼ˆå¿…è¦ãªã‚‰ items ã‚’ä¿æŒï¼‰
* **Incident indexingï¼ˆä»»æ„ï¼‰**

  * ç•°å¸¸ run ã« `INC#000001...` ã‚’ä»˜ä¸
  * ç•°å¸¸ ARL ã‚’ `{arl_out_dir}/{incident_id}__{run_id}.arl.jsonl` ã«ä¿å­˜
  * `{arl_out_dir}/incident_index.jsonl` ã«1è¡Œè¿½è¨˜
  * `{arl_out_dir}/incident_counter.txt` ã«æ°¸ç¶šã‚«ã‚¦ãƒ³ã‚¿ä¿å­˜

ç¶­æŒã—ã¦ã„ã‚‹ã‚‚ã®ï¼š

* ç•°å¸¸æ™‚ã®ã¿ ARL æ°¸ç¶šåŒ–ï¼ˆpre-context + incident + post-contextï¼‰
* æ”¹ã–ã‚“æ¤œçŸ¥ç”¨ ARL ãƒãƒƒã‚·ãƒ¥ãƒã‚§ãƒ¼ãƒ³ï¼ˆOSS ãƒ‡ãƒ¢ã¯ demo keyï¼‰
* fabricate-rate æ··åˆï¼‹seed å›ºå®šï¼ˆ`--fabricate-rate` / `--seed`ï¼‰

ã‚³ã‚¢ä¸å¤‰æ¡ä»¶ï¼š

* `sealed` ã¯ `ethics_gate` / `acc_gate` ã®ã¿ãŒè¨­å®šã§ãã‚‹
* `relativity_gate` ã¯å°å°ã—ãªã„ï¼ˆ`PAUSE_FOR_HITL`, `overrideable=True`, `sealed=False`ï¼‰

---

## V1 â†’ V4ï¼šæ¦‚å¿µçš„ã«ä½•ãŒå¢—ãˆãŸã‹

`mediation_emergency_contract_sim_v1.py` ã¯æœ€å°ã®ç›´åˆ—ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ï¼‹fail-closedï¼‹æœ€å°ãƒ­ã‚°ï¼‰ã€‚
`mediation_emergency_contract_sim_v4.py` ã¯ãã‚Œã‚’å†ç¾å¯èƒ½ãªã‚¬ãƒãƒŠãƒ³ã‚¹ãƒ»ãƒ™ãƒ³ãƒã¸æ‹¡å¼µã€‚

v4 ã§è¿½åŠ ï¼š

* Evidence gateï¼ˆç„¡åŠ¹ï¼æé€ ï¼ä¸é©åˆè¨¼æ‹ ã¯ fail-closedï¼‰
* Draft lint gateï¼ˆdraft-only ã®æ„å‘³å¢ƒç•Œã¨ã‚¹ã‚³ãƒ¼ãƒ—åˆ¶é™ï¼‰
* Trust systemï¼ˆscore + streak + cooldownï¼‰
* AUTH HITL ã®å®‰å…¨ãªè‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—ï¼ˆtrust + grantã€ARL reason ã§èª¬æ˜ï¼‰

---

## V4 â†’ V5ï¼šæ¦‚å¿µçš„ã«ä½•ãŒå¤‰ã‚ã£ãŸã‹

v4 ã¯å®‰å®šãƒ™ãƒ³ãƒï¼ˆã‚¹ãƒ¢ãƒ¼ã‚¯ï¼ã‚¹ãƒˆãƒ¬ã‚¹ï¼‰ä¸­å¿ƒã€‚
v5 ã¯æˆæœç‰©ãƒ¬ãƒ™ãƒ«ã®å†ç¾æ€§ã¨å¥‘ç´„ãƒ†ã‚¹ãƒˆã‚’å¼·åŒ–ã€‚

v5 ã§è¿½åŠ ï¼å¼·åŒ–ï¼š

* ãƒ­ã‚°ã‚³ãƒ¼ãƒ‰ãƒ–ãƒƒã‚¯ï¼ˆãƒ‡ãƒ¢ï¼‰ï¼‹å¥‘ç´„ãƒ†ã‚¹ãƒˆ
  `layer/decision/final_decider/reason_code` ã®èªå½™ã‚’ pytest ã§å›ºå®šã€‚
* å†ç¾æ€§ã‚µãƒ¼ãƒ•ã‚§ã‚¹ã®æ˜ç¢ºåŒ–
  ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ãƒ†ã‚¹ãƒˆï¼ã‚³ãƒ¼ãƒ‰ãƒ–ãƒƒã‚¯ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³å›ºå®šãŒã—ã‚„ã™ã„ã€‚
* ä¸å¤‰æ¡ä»¶ã®å¼·åŒ–
  ãƒ†ã‚¹ãƒˆã§ drift ã‚’æ¤œçŸ¥ã—ã€ã‚µã‚¤ãƒ¬ãƒ³ãƒˆç ´å£Šã‚’é¿ã‘ã‚‹ã€‚

v5 ã§ã‚‚å¤‰ã‚ã‚‰ãªã„ã“ã¨ï¼š

* ç ”ç©¶ï¼æ•™è‚²ç›®çš„
* Fail-closed + HITL ã®æ„å‘³è«–
* åˆæˆãƒ‡ãƒ¼ã‚¿ã®ã¿ã€éš”é›¢ç’°å¢ƒã§å®Ÿè¡Œ
* å®‰å…¨æ€§ä¿è¨¼ã¯ã—ãªã„ï¼ˆã‚³ãƒ¼ãƒ‰ãƒ–ãƒƒã‚¯ã¯æš—å·ã§ã¯ãªã„ï¼ãƒ†ã‚¹ãƒˆã¯å®Ÿé‹ç”¨å®‰å…¨ã‚’ä¿è¨¼ã—ãªã„ï¼‰

---

## å®Ÿè¡Œä¾‹

Doc orchestratorï¼ˆå‚ç…§å®Ÿè£…ï¼‰

```bash
python ai_doc_orchestrator_kage3_v1_2_4.py
```

Emergency contractï¼ˆæ¨å¥¨ï¼šv5.1.2ï¼‰ï¼‹å¥‘ç´„ãƒ†ã‚¹ãƒˆ

```bash
python mediation_emergency_contract_sim_v5_1_2.py
pytest -q tests/test_v5_1_codebook_consistency.py
```

Emergency contractï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼å®‰å®šï¼šv4.8ï¼‰

```bash
python mediation_emergency_contract_sim_v4_8.py
pytest -q tests/test_mediation_emergency_contract_sim_v4_8_smoke_metrics.py
```

Emergency contractï¼ˆv4.4 stressï¼‰

```bash
python mediation_emergency_contract_sim_v4_4_stress.py --runs 10000 --out stress_results_v4_4_10000.json
```

---

## ç›®çš„ï¼éç›®çš„ï¼ˆNon-goalsï¼‰

ç›®çš„ï¼š

* å†ç¾å¯èƒ½ãªå®‰å…¨ï¼ã‚¬ãƒãƒŠãƒ³ã‚¹ãƒ»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
* HITL ã®æ˜ç¤ºï¼ˆpause/reset/banï¼‰
* ç›£æŸ»å¯èƒ½ãªåˆ¤æ–­ãƒˆãƒ¬ãƒ¼ã‚¹ï¼ˆæœ€å° ARLï¼‰

éç›®çš„ï¼š

* æœ¬ç•ªå‘ã‘ã®è‡ªå¾‹é‹ç”¨
* ç„¡åˆ¶é™ãªè‡ªå·±ä¸»å°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ¶å¾¡
* æ˜ç¤ºçš„ã«ãƒ†ã‚¹ãƒˆã•ã‚Œã¦ã„ãªã„ç¯„å›²ã®å®‰å…¨æ€§ä¸»å¼µ

---

## ãƒ‡ãƒ¼ã‚¿ï¼å®‰å…¨ãƒ¡ãƒ¢

* åˆæˆï¼ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ã¿ã€‚
* å®Ÿè¡Œãƒ­ã‚°ã®ã‚³ãƒŸãƒƒãƒˆã¯é¿ã‘ã€æˆæœç‰©ã¯æœ€å°ï¼†å†ç¾å¯èƒ½ã«ã€‚
* zip ãƒãƒ³ãƒ‰ãƒ«ã¯ã€Œãƒ¬ãƒ“ãƒ¥ãƒ¼å¯èƒ½ãªè¨¼è·¡ã€ã§ã‚ã‚Šã€æ¨©å¨ãƒ­ã‚¸ãƒƒã‚¯ã§ã¯ãªã„ã€‚

---

## License

Apache License 2.0 (see `LICENSE`)
